=== Проблема ABA

Ситуація зображена на діаграмі нижче називається "Проблема ABA".

[plantuml,target=aba_problem_sequence_diagram,format=svg]
----
autonumber
participant t1 as "Потік 1"
participant r as "Ресурс"
participant t2 as "Потік 2"

t1 -> r: читає "A"
t2 -> r: записує "B"
t2 -> r: записує "A"
t1 -> r: читає "A"
----

Тут перший потік не може визначити що над ресурсом була зроблена якась модифікація іншим потоком який змінює ресурс на якесь значення, а потім змінює його на початкове.
Наслідки цієї ситуації можуть призвести до неправильної роботи програми якщо для неї важливо відстежувати зміну стану ресурсу.

Наступна діаграма зображає цю проблему на прикладі реалізації наївної версії алгоритму без блокування (CAS алгоритм) зв'язаного списку:

[plantuml,target=aba_problem_sequence_diagram,format=svg]
----
skinparam defaultFontName FONT_FIRA_MONO
autonumber
participant t1 as "Потік 1"
participant r as "Зв'язаний список\n з наївним CAS алгоритмом"
participant t2 as "Потік 2"

note over r
head=A->B->C->D->null
end note
note over t1
Отримує завдання видалити A
end note
note over t2
Отримує завдання видалити A
end note
t1 -> r: копіює посилання на перший елемент\n списку в свою змінну t1_head
note over t1
t1_head=A->B->C->D->null
end note
t1 -> t1: змінює t1_head на елемент на який вказує A
note over t1
t1_head=B->C->D->null
end note
t2 -> r: копіює посилання на перший елемент\n списку в свою змінну t2_head
note over t2
t2_head=A->B->C->D->null
end note
t2 -> t2: змінює t2_head на елемент на який вказує A
note over t2
t2_head=B->C->D->null
end note
t2 -> r: змінює head на t2_head CAS операцією
note over r
head=B->C->D->null
end note
t2->t2: видаляє посилання на B у елемента A
note over t2
Отримує завдання видалити B
end note
t2 -> r: копіює посилання на перший елемент\n списку в свою змінну t2_head
note over t2
t2_head=B->C->D->null
end note
t2 -> t2: змінює t2_head на елемент на який вказує B
note over t2
t2_head=C->D->null
end note
t2 -> r: змінює head на t2_head CAS операцією
note over r
head=C->D->null
end note
t2->t2: видаляє посилання на C у елемента B
note over t1
t1_head=B->null
end note
note over t2
Отримує завдання вставити A першим елементом
end note
t2 -> r: копіює посилання на перший елемент\n списку в свою змінну t2_head
note over t2
t2_head=C->D->null
end note
t2 -> t2: змінює t2_head відповідно завданню
note over t2
t2_head=A->C->D->null
end note
t2 -> r: змінює head на t2_head CAS операцією
note over r
head=A->C->D->null
end note
t1 -> r: змінює head на t1_head CAS операцією
note over r
head=B->null
end note
----

Приклад:

[source,java,linenos]
----
include::ABAProblem.java[]
----

Вивід в консоль:

[source,bash,linenos]
----
Given list: ABANode[val=A, next=ABANode[val=B, next=ABANode[val=C, next=ABANode[val=D, next=null]]]]
t2: updated = true, list: ABANode[val=B, next=ABANode[val=C, next=ABANode[val=D, next=null]]]
t2: updated = true, list: ABANode[val=C, next=ABANode[val=D, next=null]]
t2: updated = true, list: ABANode[val=A, next=ABANode[val=C, next=ABANode[val=D, next=null]]]
t1: updated = true, list: ABANode[val=B, next=null]
Result list: ABANode[val=B, next=null]
----